<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin=anonymous referrerpolicy=no-referrer><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin=anonymous></script><meta name=viewport content="width=device-width,initial-scale=1"><script src=https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4></script><link rel=preconnect href=https://fonts.bunny.net><link href="https://fonts.bunny.net/css?family=ibm-plex-sans:300,400,400i,500,500i,600,700,700i" rel=stylesheet><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script>window.MathJax={loader:{load:["[tex]/physics"]},tex:{packages:{"[+]":["physics"]}}}</script><title>pipe</title>
<meta name=description content="pipe chains the STDOUT of one command and put it to the STDIN of another command. Typically, we want to do pipe per direction.
command pipelines

span two child processes
create a pipe to allow the two processes to communicate
connect the first child&rsquo;s STDOUT to the pipe + the second child&rsquo;s STDIN to the pipe

pipe()
pipe() gives us back two file descriptors, such that whatever is written to one can be read from another."><meta name=author content="Houjun Liu"><link rel=stylesheet href=/css/all.css><link rel=stylesheet href=/css/page.css><link rel=stylesheet href=/css/syntax.css><link rel=stylesheet href=/css/typography.css><link rel=stylesheet href=/css/components.css></head><body><div class="center-clearfix p-10" style="max-width:1200px;margin:0 auto"><header class=pb-4><span class="w-full flex justify-between flex-wrap"><div style=font-weight:600;font-size:15px><a style=border:0;cursor:pointer href=/><img src=/images/Logo_Transparent.png style=width:17px;display:inline-block;margin-right:8px;transform:translateY(-2.7px)></a>pipe</div><span style="float:right;display:flex;align-items:center;margin-top:5px;width:100%;max-width:400px;background:#fff;border-radius:2px;border:1px solid var(--gray-2);position:relative"><i class="fa-solid fa-magnifying-glass" style=font-size:12px;color:var(--yellow-fg);margin-right:7px;margin-left:10px></i><div style=width:100%><input id=search-query-inline name=s type=text autocomplete=off placeholder="Search Knowledgebase" enterkeyhint=search></div><div id=search-result-inline style=display:none></div><script id=search-result-template type=text/x-js-template data-template=searchresult>
    <a href="${link}" class="search-link">
    <div class="search-result-item" id="search-result-item-${key}">
        <div class="search-result-title">${title}</div>
        <div class="search-result-summary">${snippet}</div>
    </div>
    </a>
</script><script src=https://code.jquery.com/jquery-3.3.1.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.0/fuse.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js></script><script type=module>
    import { create, insertMultiple, search } from 'https://cdn.jsdelivr.net/npm/@orama/orama@latest/+esm'
    let template = $('script[data-template="searchresult"]').text().split(/\$\{(.+?)\}/g);

    function render(props) {
        return function(tok, i) { return (i % 2) ? props[tok] : tok; };
    }

    const db = create({
        schema: {
            title: 'string',
            content: 'string',
        },
    });
    $.get("https://www.jemoka.com/index.json", function(data, status){
        insertMultiple(db, data.map(x =>
            ({title: x.title, content: x.contents, link: x.permalink})));
    });
    $("#search-result-inline").attr("tabindex", "-1");
    $(document).on("click", function (e) {
    if (!$(e.target).closest("#search-query-inline, #search-result-inline").length) {
        $("#search-result-inline").hide();
    }
    });
    
    
    
    
    
    

    $("#search-query-inline").on("focus keyup", function () {
        let value = $(this).val();
        if (value.trim() == "") {
            $("#search-result-inline").html("");
            $("#search-result-inline").hide();
            return;
        }
        $("#search-result-inline").show();
        let results = search(db, {mode: "fulltext", term: value});
        let contents = results.hits.map(x => template.map(render({
            title: x.document.title,
            snippet: x.document.content.slice(0, 52),
            key: x.id,
            link: x.document.link
        })).join(''));
        $("#search-result-inline").html(contents.join("\n"));
        
    });
    if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
        $('#search-query-inline').on('focus', function(){
            
            $(this).data('fontSize', $(this).css('font-size')).css('font-size', '16px');
        }).on('blur', function(){
            
            $(this).css('font-size', $(this).data('fontSize'));
        });
    }

</script></span></span><div class=w-full style="padding-bottom:4px;border-bottom:1px solid var(--gray-1);margin-top:1px"></div></header><aside id=tocbox><div id=heading style=padding-left:40px;font-weight:600;font-size:11px;color:var(--gray-3)>contents</div><div id=toc></div></aside><main><article><div style=max-width:700px><p><a href=/posts/kbhpipe/>pipe</a> chains the STDOUT of one command and put it to the STDIN of another command. Typically, we want to do pipe per direction.</p><h2 id=command-pipelines>command pipelines</h2><ol><li>span two child processes</li><li>create a pipe to allow the two processes to communicate</li><li>connect the first child&rsquo;s STDOUT to the pipe + the second child&rsquo;s STDIN to the pipe</li></ol><h2 id=pipe>pipe()</h2><p><a href=#pipe>pipe()</a> gives us back two <a href=/posts/kbhsyscalls/#file-descriptor>file descriptor</a>s, such that whatever is written to one can be read from another.</p><p>Interface:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#00a8c8>int</span> <span style=color:#111>pipes</span><span style=color:#111>[</span><span style=color:#ae81ff>2</span><span style=color:#111>];</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// create the pipes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#00a8c8>int</span> <span style=color:#111>ret</span> <span style=color:#f92672>=</span> <span style=color:#75af00>pipe</span><span style=color:#111>(</span><span style=color:#111>pipes</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// an so
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#00a8c8>int</span> <span style=color:#111>read_from_here</span> <span style=color:#f92672>=</span> <span style=color:#111>ret</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>];</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>int</span> <span style=color:#111>write_to_here</span> <span style=color:#f92672>=</span> <span style=color:#111>ret</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>];</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// i.e. ret[1] writes to =&gt; ret[0] read
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// fork!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#00a8c8>pid_t</span> <span style=color:#111>pid_p</span> <span style=color:#f92672>=</span> <span style=color:#75af00>fork</span><span style=color:#111>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#111>pid_p</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// child subroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// because child is READING, and not READINg
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// we want to close the write
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75af00>close</span><span style=color:#111>(</span><span style=color:#111>write_to_here</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// we want to then make a buffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#00a8c8>char</span> <span style=color:#111>buf</span><span style=color:#111>[</span><span style=color:#111>num_bytes</span><span style=color:#111>];</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// if the child reads before the parents write
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// it will block until some data is available
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// if the write ends are closed globally, read
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// will also stop.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75af00>read</span><span style=color:#111>(</span><span style=color:#111>read_from_here</span><span style=color:#111>,</span> <span style=color:#111>buffer</span><span style=color:#111>,</span> <span style=color:#00a8c8>sizeof</span><span style=color:#111>(</span><span style=color:#111>buffer</span><span style=color:#111>));</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>close</span><span style=color:#111>(</span><span style=color:#111>read_from_here</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// parent subroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e>// because parent is WRITING and not READING
</span></span></span><span style=display:flex><span><span style=color:#75715e>// we don&#39;t want the read to block, we will
</span></span></span><span style=display:flex><span><span style=color:#75715e>// close the parent immediately.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>close</span><span style=color:#111>(</span><span style=color:#111>read_from_here</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// write some data
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>write</span><span style=color:#111>(</span><span style=color:#111>write_to_here</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;msg&#34;</span><span style=color:#111>,</span> <span style=color:#111>num_bytes</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// close now we are done writing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>close</span><span style=color:#111>(</span><span style=color:#111>write_to_here</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// clean up child
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>waitpid</span><span style=color:#111>(</span><span style=color:#111>pid_p</span><span style=color:#111>,</span> <span style=color:#111>NULL</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>);</span>
</span></span></code></pre></div><p><a href=/posts/kbhpipe/>pipe</a>s have to be closed twice, and opened before the fork.</p><h2 id=dup2>dup2()</h2><p><a href=#dup2>dup2()</a> lets you <strong>REWIRE</strong> fire descriptors:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75af00>dup2</span><span style=color:#111>(</span><span style=color:#111>scrfd</span><span style=color:#111>,</span> <span style=color:#111>destft</span><span style=color:#111>);</span>
</span></span></code></pre></div><p>for instance:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75af00>dup2</span><span style=color:#111>(</span><span style=color:#111>fds</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>],</span> <span style=color:#111>STDIN_FILENO</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#75af00>close</span><span style=color:#111>(</span><span style=color:#111>fds</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]);</span>
</span></span></code></pre></div><p>copy the underlying open file pointer which <code>fds[0]</code> points to the FD STDIN, meaning STDIN will now refer to the underlying file of <code>fds[0]</code>.</p><h2 id=stalling>stalling</h2><p>if you <strong>don&rsquo;t close the right ends of your pipes, it STALLS</strong>. <code>read()</code> BLOCKS UNTIL ALL WRITES ARE CLOSED!</p></div></article></main><footer style=margin-top:20px><p id=footer style=font-size:8px;color:var(--gray-3)>&copy; 2019-2025 Houjun Liu. Licensed CC BY-NC-SA 4.0.</p></footer></div><script src=https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.32.2/tocbot.min.js></script><script>tocbot.init({tocSelector:"#toc",contentSelector:".center-clearfix",headingSelector:"h1, h2, h3",hasInnerContainers:!0})</script></body></html>